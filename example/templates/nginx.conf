{{ if .Upgrade -}}
# websocket upgrade
map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
}
{{- end }}

# Redirect all HTTP traffic to HTTPS
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name _;

        return 301 https://$host$request_uri;
}

# Server configuration
server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;

        server_name _;

        # enable subfolder method reverse proxy confs
        include /config/nginx/proxy-confs/*.subfolder.conf;

        # all ssl related config moved to ssl.conf
        include /config/nginx/ssl.conf;

        location / {
                proxy_pass            http://{{ .Service.Name }}:{{ .ServicePort }};
                proxy_set_header      Host $host;
                proxy_http_version    1.1;
                {{ if .Upgrade -}}
                proxy_set_header      Upgrade $http_upgrade;
                proxy_set_header      Connection $connection_upgrade;
                {{- end }}
        }
}

# enable subdomain method reverse proxy confs
include /config/nginx/proxy-confs/*.subdomain.conf;